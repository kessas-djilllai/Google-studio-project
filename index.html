<?php require 'db.php'; 
if (!isset($_SESSION['user_id'])) { header("Location: auth.php"); exit; }

$stmt = $mysqli->prepare("SELECT balance FROM users WHERE id = ?");
$stmt->bind_param('i', $_SESSION['user_id']);
$stmt->execute();
$stmt->bind_result($user_balance);
$stmt->fetch();
$stmt->close();
?>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة التحكم</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { margin:0; padding:0; font-family: Arial; background: linear-gradient(to bottom, #a855f7, #3b82f6, #ffffff); min-height:100vh; color:white; }
        .top-balance { position:fixed; top:20px; left:20px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:20px; backdrop-filter:blur(10px); }
        .sidebar { position:fixed; right:0; top:0; width:250px; height:100%; background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); padding:20px; }
        .glass-card { background: rgba(255,255,255,0.15); backdrop-filter: blur(12px); border-radius: 20px; padding:20px; margin:20px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        .clay-btn { background:#e0e0e0; box-shadow: 10px 10px 20px #bebebe, -10px -10px 20px #ffffff; border-radius:15px; padding:15px; }
        .clay-card { background:#e0e0e0; box-shadow: 20px 20px 40px #bebebe, -20px -20px 40px #ffffff, inset 5px 5px 10px #ffffff, inset -5px -5px 10px #bebebe; border-radius:25px; }
        .content { margin-right:270px; padding:50px; }
    </style>
</head>
<body>
<div class="top-balance">رصيدك: <?php echo $user_balance; ?> KD</div>

<div class="sidebar">
    <h3>القائمة</h3>
    <input type="text" id="apiKeyInput" placeholder="أدخل API Key">
    <button onclick="saveApi()" class="clay-btn">حفظ في LocalStorage</button>
    <hr>
    <a href="vip.php" style="color:white; display:block;">الاشتراكات (VIP)</a>
</div>

<div class="content">
    <h1>لوحة التحكم</h1>
    <div style="display:flex; flex-wrap:wrap;">
        <div class="glass-card clay-card" style="width:300px; text-align:center; cursor:pointer;" onclick="checkBalanceAndGo('plan_ai.php')">
            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
            <h3>توليد خطة (AI)</h3>
            <p>توليد آلي بناءً على العنوان</p>
        </div>
        <div class="glass-card clay-card" style="width:300px; text-align:center; cursor:pointer;" onclick="checkBalanceAndGo('plan_human.php')">
            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            <h3>توليد يدوي</h3>
            <p>إدخال المباحث والمطالب</p>
        </div>
    </div>
</div>

<script>
function saveApi() {
    const key = document.getElementById('apiKeyInput').value;
    if(key) {
        localStorage.setItem('gemini_api_key', key);
        Swal.fire('تم', 'تم حفظ الـ API بنجاح', 'success');
    }
}
function checkBalanceAndGo(url) {
    const balance = <?php echo $user_balance; ?>;
    if (balance > 0) {
        window.location.href = url;
    } else {
        Swal.fire({
            title: 'نفذ رصيدك',
            text: "يرجى الاشتراك في الباقات",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'الذهاب للاشتراكات'
        }).then((result) => {
            if (result.isConfirmed) window.location.href = 'vip.php';
        });
    }
}
</script>
</body>
</html>